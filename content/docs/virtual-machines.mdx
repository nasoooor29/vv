---
title: Virtual Machines
description: QEMU/KVM virtual machine management
---

# Virtual Machine Management

Visory integrates with libvirt to provide comprehensive QEMU/KVM virtual machine management.

## Overview

The VM management feature allows you to:
- Create and configure virtual machines
- Start, stop, and reboot VMs
- Monitor VM resources and status
- View VM details and configuration

## Prerequisites

Ensure libvirt is installed and running on your system:

```bash
# Debian/Ubuntu
sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients

# Start libvirtd
sudo systemctl start libvirtd
sudo systemctl enable libvirtd
```

## Required Permissions

| Action | Permission |
|--------|------------|
| View VMs | `qemu_read` |
| Create/Start VMs | `qemu_write` |
| Reboot/Shutdown | `qemu_update` |
| Delete VMs | `qemu_delete` |

## Accessing VM Management

Navigate to **Virtual Machines** in the sidebar (requires `qemu_read` permission).

## VM Operations

### Viewing Virtual Machines

The VM grid displays all virtual machines with:
- VM name
- UUID
- State (running, stopped, etc.)
- Memory allocation
- vCPU count

### VM Details

Click on a VM to view detailed information:
- UUID
- Current state
- Memory (current and maximum)
- vCPU configuration
- CPU time consumed

### Creating a Virtual Machine

1. Click **Create VM**
2. Configure the VM:
   - **Name**: Unique identifier for the VM
   - **Memory**: RAM allocation in MB
   - **vCPUs**: Number of virtual CPUs
   - **Disk Size**: Storage size in GB
   - **OS Image**: Optional ISO or image path
   - **Autostart**: Start VM on host boot
3. Click **Create**

#### Create VM Request

```json
{
  "name": "my-vm",
  "memory": 2048,
  "vcpus": 2,
  "disk_size": 20,
  "os_image": "/path/to/image.iso",
  "autostart": false
}
```

### VM Actions

| Action | Description | Permission |
|--------|-------------|------------|
| Start | Boot the VM | `qemu_write` |
| Reboot | Restart the VM | `qemu_update` |
| Shutdown | Gracefully stop the VM | `qemu_update` |

## VM States

| State | Code | Description |
|-------|------|-------------|
| No State | 0 | Unknown or undefined state |
| Running | 1 | VM is running |
| Blocked | 2 | VM is blocked on resource |
| Paused | 3 | VM is paused |
| Shutting Down | 4 | VM is shutting down |
| Shut Off | 5 | VM is completely stopped |
| Crashed | 6 | VM has crashed |
| Suspended | 7 | VM is suspended to disk |

## Real-Time Polling

Visory implements automatic polling to keep VM status up-to-date. See [Polling Documentation](/docs/polling) for details.

### Using Polling Hooks

```typescript
import { usePollingVMs, usePollingVM } from '@/hooks';

// Poll all VMs every 5 seconds
const { data: vms } = usePollingVMs({ interval: 5000 });

// Poll single VM every 3 seconds
const { data: vm } = usePollingVM(vmUUID, { interval: 3000 });
```

## API Reference

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/qemu/virtual-machines` | GET | List all VMs |
| `/api/qemu/virtual-machines/info` | GET | List VMs with detailed info |
| `/api/qemu/virtual-machines/:uuid` | GET | Get specific VM |
| `/api/qemu/virtual-machines/:uuid/info` | GET | Get VM with detailed info |
| `/api/qemu/virtual-machines` | POST | Create new VM |
| `/api/qemu/virtual-machines/:uuid/start` | POST | Start VM |
| `/api/qemu/virtual-machines/:uuid/reboot` | POST | Reboot VM |
| `/api/qemu/virtual-machines/:uuid/shutdown` | POST | Graceful shutdown |

## VM Information Response

```json
{
  "uuid": "550e8400-e29b-41d4-a716-446655440000",
  "name": "my-vm",
  "state": 1,
  "memory_kb": 2097152,
  "max_memory_kb": 2097152,
  "vcpus": 2,
  "cpu_time_ns": 12345678900
}
```

## Troubleshooting

### "Failed to connect to libvirt"

Ensure libvirtd is running:

```bash
sudo systemctl status libvirtd
```

Check permissions:

```bash
# Add user to libvirt group
sudo usermod -aG libvirt $USER
```

### VM stuck in "Shutting Down" state

Force stop the VM using virsh:

```bash
virsh destroy vm-name
```

### Cannot allocate memory

Check available system memory and reduce VM memory allocation or stop other VMs.

## Best Practices

1. **Resource Planning**: Don't overcommit CPU or memory beyond host capacity
2. **Use Meaningful Names**: Give VMs descriptive names for easy identification
3. **Regular Backups**: Backup VM disk images regularly
4. **Monitor Resources**: Use polling to track VM resource usage
5. **Graceful Shutdown**: Always prefer shutdown over force stop to prevent data loss
